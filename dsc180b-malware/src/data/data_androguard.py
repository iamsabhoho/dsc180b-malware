from androguard import misc
from androguard import session


def decompile_apk(filepath, session_n = ""):
    '''
    decompiles an apk and returns a, d, dx

    filepath --> path to the APK file
    session_n --> session filename, extension is '.ag'

    function returns a list with items: [a, d, dx]
    a: APK object
    d: array of DalvikVMFormat
    dx: Analysis object
    '''

    # stores a session, we can return to work on this later
    if session != "":
        sess = misc.get_default_session()
        a, d, dx = misc.AnalyzeAPK(filepath, session = sess)
        session.Save(sess, "sessions/"+session_n)
        return [a, d, dx]
    else:
        a, d, dx = misc.AnalyzeAPK(filepath)
        return [a, d, dx]



def basic_blocks(ag_file):
    """
    obtains the basic blocks from an ag_file, builds edges

    """
    raw = []
    apis = []
    codeblocks = []


    for subdir, dirs, files in os.walk(fp):
        for filename in files:
            fp = subdir + os.sep + filename
            if fp.endswith(".smali") or fp.endswith(".smali"):
                with open(fp, encoding = "utf-8") as file:
                    f = file.read()

                    raw = np.array(re.findall(r"invoke-.+\s?L.*;", f), dtype = object)
                    raw_ind = np.array([appid] * len(np.unique(raw)))
                    codeblocks = np.array(re.split("\.method", f), dtype = object)
                    codeblock_ind = np.array([appid] * len(codeblocks))



                    with open("csv/%s_api_calls_w_appid.csv"%ver, "a") as api_txt:
                        np.savetxt(api_txt, np.vstack((raw_ind, np.unique(raw))).T,delimiter = ",", fmt = '"%s"')
                    api_txt.close()

                    with open("csv/%s_codeblocks_w_appid.csv"%ver, "a") as codeblock_txt:
                        np.savetxt(codeblock_txt, np.vstack((codeblock_ind, codeblocks)).T,delimiter = ",", fmt = '"%s"')
                    codeblock_txt.close()


    #                     apis = apis + re.findall("(L[\/\d\w(->)]*\;)", f)

                file.close()
