from androguard import misc
from androguard import session


def decompile_apk(filepath, session_n = ""):
    '''
    decompiles an apk and returns a, d, dx

    filepath --> path to the APK file
    session_n --> session filename, extension is '.ag'

    function returns a list with items: [a, d, dx]
    a: APK object
    d: array of DalvikVMFormat
    dx: Analysis object
    '''

    # stores a session, we can return to work on this later
    if session != "":
        sess = misc.get_default_session()
        a, d, dx = misc.AnalyzeAPK(filepath, session = sess)
        session.Save(sess, "sessions/"+session_n)
        return [a, d, dx]
    else:
        a, d, dx = misc.AnalyzeAPK(filepath)
        return [a, d, dx]



def basic_blocks(ag_file):
    """
    obtains the basic blocks from an ag_file, builds edges

    """
    raw = []
    apis = []
    codeblocks = []


    for subdir, dirs, files in os.walk(fp):
        for filename in files:
            fp = subdir + os.sep + filename
            if fp.endswith(".smali") or fp.endswith(".smali"):
                with open(fp, encoding = "utf-8") as file:
                    f = file.read()

                    raw = np.array(re.findall(r"invoke-.+\s?L.*;", f), dtype = object)
                    raw_ind = np.array([appid] * len(np.unique(raw)))
                    codeblocks = np.array(re.split("\.method", f), dtype = object)
                    codeblock_ind = np.array([appid] * len(codeblocks))



                    with open("csv/%s_api_calls_w_appid.csv"%ver, "a") as api_txt:
                        np.savetxt(api_txt, np.vstack((raw_ind, np.unique(raw))).T,delimiter = ",", fmt = '"%s"')
                    api_txt.close()

                    with open("csv/%s_codeblocks_w_appid.csv"%ver, "a") as codeblock_txt:
                        np.savetxt(codeblock_txt, np.vstack((codeblock_ind, codeblocks)).T,delimiter = ",", fmt = '"%s"')
                    codeblock_txt.close()


    #                     apis = apis + re.findall("(L[\/\d\w(->)]*\;)", f)

                file.close()


def useful_functions(a, d, dx):
    """
    some useful functions for a decompiled APK


    a --> APK object
    d --> array of DalvikVMFormat object
    dx --> analysis object


    """


    ### attributes and methods for a --> APK Class

    test_obj = a.get_permissions()
    # Returns all requested permissions.

    test_obj = a.get_requested_aosp_permissions_details()
    # Returns requested aosp permissions with details.

    test_obj = a.get_libraries()
    # Return the android:name attributes for libraries

    display(type(test_obj))


    ### attributes and methods for d --> DalvikVMFormat

    test_d = d[0].get_all_fields()
    # Return a list of field items

    test_d = d[0].get_classes()
    # Returns all classes --> returns a ClassDefItem

    test_d = d[0].get_fields()
    # Returns all field objects --> EncodedField Object

    test_d = d[1].get_len_methods()
    # Return the number of methods

    test_d = d[1].get_methods()
    # Returns all method objects --> EncodedMethod Objects

    test_d = d[1].get_strings()
    # returns all Strings

    # test_d

    # for item in test_d:
    #     if len(item.get_name()) > 1:
    #         print(item.get_name())

    ### Prints the fields, or classes, or methods, (can be used for EDA)
    # ct = 0
    # for item in d[0].get_fields():
    #     if ct < 600:
    #         print(item)
    #         ct+= 1
    #     else:
    #         break


def get_graph_info(digraph):
    """
    Takes in a networkx digraph and output some statistics for the graph

    params: digraph --> networkx digraph object
    prints: --> number of nodes, and edges.
    """

    print("Number of nodes in this graph is: ", len(digraph.nodes()))
    print("Number of edges in this graph is: ", len(digraph.edges()))


    
